<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssm.dao.YTaskManagerMapper">
	<resultMap type="com.ssm.vo.YTaskListVo" id="baseResultMap">
		<result property="id" column="id" />
		<result property="clazzName" column="clazz_name" />
		<result property="clazzId" column="clazz_id" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="currentType" column="current_type" />
		<result property="status" column="status" />
		<result property="examPaperTitle" column="exam_paper_title" />
	</resultMap>
	
	<!-- # 包括删除的  ，降序排序，交给分页插件去做。-->
	<select id="renderTaskList" resultMap="baseResultMap">
		SELECT
			txp.id,
			tc.clazz_name,
			tc.id as 'clazz_id',
			txp.start_time,
			txp.end_time,
			txp.current_type,
			txp.`status`,
			txpt.exam_paper_title 
		FROM
			t_exam_publish txp
			LEFT JOIN ( SELECT id, clazz_name FROM t_clazz WHERE `status` = 1 ) tc ON tc.id = txp.clazz_id
			LEFT JOIN ( SELECT * FROM t_exam_paper WHERE `status` = 1 ) txpt ON txpt.id = txp.exam_id
		<where>
			<if test="clazzId!=null">
				AND tc.id = #{clazzId}
			</if>
			<if test="currentType!=null">
				AND txp.current_type= #{currentType}
			</if>
		</where>
		ORDER BY txp.id desc, txp.end_time desc	
	</select>
	
	<!-- 删除这场任务  -->
	<update id="deleteTaskByIds" > 
		UPDATE t_exam_publish SET `status` = 2 WHERE id in 
		<foreach collection="array" item="itemData" open="(" close=")" separator=",">
			#{itemData}
		</foreach>
	</update>
	<!--  删除这场任务班级信息。-->
	<delete id="deleteClazzTask" >
		delete from t_clazz_exam_info where exam_task_id in 
		<foreach collection="array" open="(" close=")" item="itemData" separator=",">
			#{itemData}
		</foreach>
	</delete>
	<!-- 删除这场任务的学生所对应的记录 -->
	<update id="deleteStudentRos">
		update  t_exam_record set `status` = 2 where exam_pulish_id in
		<foreach collection="array" open="(" close=")" separator="," item="itemData">
			#{itemData}
		</foreach>
	</update>
	
	<!-- 删除这场任务的学生答案发布任务记录 -->
	<update id="deleteStudentAsnwer">
		update  t_student_exam_answer set `status` = 2 where exam_pulish_id in 
		<foreach collection="array" open="(" close=")" separator="," item="itemData">
		 	#{itemData}
		</foreach>
	</update>
	
	<select id="renderExamDetail" resultType="com.ssm.vo.YExamQuestionVO">
			SELECT
				tq.id as 'questionId',
			    tq.question_content as 'questionContent',
			    tq.question_score as 'questionScore',
				td.label as 'questionType'
			FROM
				( SELECT * FROM t_question WHERE `status` = 1 ) tq
				LEFT JOIN ( SELECT * FROM t_dict WHERE type = 1 AND `status` = 1 ) td ON tq.question_type = td.`value` 
			WHERE
				tq.id IN  ( SELECT question_id FROM t_exam_paper_question WHERE exam_id = #{0}  )
			ORDER BY  tq.id DESC
	</select>
	
	
	
</mapper>