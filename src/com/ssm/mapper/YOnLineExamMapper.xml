<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssm.dao.YOnLineExamMapper">
	<!-- 视图映射考试任务resultMap -->
	<resultMap type="com.ssm.vo.YOnLineTaskListVO" id="examTaskViewObjectResultMap">
		
		<id property="id" column="id" />
		
		<result property="examId" column="exam_id" />
		<result property="startTime" column="start_time" />
		<result property="endTime" column="end_time" />
		<result property="clazzId" column="clazz_id" />
		<result property="status" column="status" />
		<result property="currentType" column="current_type"/>
		<result property="publishPerson" column="publish_person" />
		<result property="clazzName" column="clazz_name" />
		<result property="examPaperTitle" column="exam_paper_title" />
		<result property="examPaperTotalScroe" column="exam_paper_total_scroe" />
		<result property="username" column="username" />
	</resultMap>
	
	
	<resultMap type="com.ssm.vo.YExamQuestionVO" id="examQuestionAllResultMap">
		<id property="questionId" column="question_id" />
		<result property="examId" column="exam_id" />
		<result property="questionContent" column="question_content" />
		<result property="questionScore" column="question_score" />
		<result property="questionType" column="question_type" />
		<result property="questionTypeId" column="question_type_id" />
		<result property="myAnswer" column="my_answer" />
		<collection property="answerList" ofType="com.ssm.vo.YExamQuestionAnswerVO">
			<id property="answerId" column="answer_id"/>
			<result property="isAnswerTrue" column="is_answer_true" />
			<result property="answerContent" column="answer_content" />
			<result property="answerSelect" column="answer_select" />
		</collection>
	</resultMap>
	
	<!-- 查询任务考场列表，并且为存在的。 按最晚时间降序.如果相同则id降序 --> 
	<select id="selectOnLineTaskListAndExsting" resultMap="examTaskViewObjectResultMap">
		SELECT
			tep.*,
			tc.clazz_name,
			tepa.exam_paper_title,
			tepa.exam_paper_total_scroe,
			tu.username 
		FROM
			( SELECT * FROM t_exam_publish WHERE `status` = 1 ) tep
			LEFT JOIN ( SELECT * FROM t_clazz WHERE `status` = 1 ) tc ON tep.clazz_id = tc.id
			LEFT JOIN ( SELECT * FROM t_exam_paper WHERE `status` = 1 ) tepa ON tep.exam_id = tepa.id
			LEFT JOIN ( SELECT * FROM t_user WHERE `status` = 1 ) tu ON tep.publish_person = tu.id 
		
	</select>
	<select id="selectOnLineExamRenderInfo" resultMap="examTaskViewObjectResultMap">
		SELECT
				tep.*,
				tc.clazz_name,
				tepa.exam_paper_title,
				tepa.exam_paper_total_scroe
			FROM
				( SELECT * FROM t_exam_publish WHERE `status` = 1 ) tep
				LEFT JOIN ( SELECT * FROM t_clazz WHERE `status` = 1 ) tc ON tep.clazz_id = tc.id
				LEFT JOIN ( SELECT * FROM t_exam_paper WHERE `status` = 1 ) tepa ON tep.exam_id = tepa.id
			WHERE tep.id = #{0}
	</select>
	<select id="selectQuestionAllByTaskId" resultMap="examQuestionAllResultMap">
		SELECT
		  tepa.id as 'exam_id',
			tq.id as 'question_id',
			tq.question_type as 'question_type_id',
			tq.question_content,
			ta.is_answer_true,
			tq.question_score,
			td1.label as 'question_type',
			ta.id AS 'answer_id',
			ta.answer_content,
			td2.label as 'answer_select'
		FROM
			( SELECT * FROM t_exam_publish WHERE `status` = 1 ) tep
			LEFT JOIN ( SELECT * FROM t_exam_paper WHERE `status` = 1 ) tepa ON tepa.id = tep.exam_id
			LEFT JOIN t_exam_paper_question txpq ON tepa.id = txpq.exam_id
			LEFT JOIN ( SELECT * FROM t_question WHERE `status` = 1 ) tq ON txpq.question_id = tq.id
			LEFT JOIN ( SELECT * FROM t_dict WHERE `status` = 1 AND type = 1 ) td1 ON tq.question_type = td1.`value`
			LEFT JOIN t_answer ta ON tq.id = ta.question_id
			LEFT JOIN (select * from t_dict  where `status` = 1 )td2  on  td2.id = ta.answer_select 
		WHERE
			tep.id = #{0}
	</select>
	
	<select id="selectOnLineTaskQuestionAnswerTrue" resultMap="examQuestionAllResultMap">
		SELECT
		  tepa.id as 'exam_id',
			tq.id as 'question_id',
			tq.question_type as 'question_type_id',
			tq.question_content,
			tq.question_score,
			td1.label as 'question_type',
			ta.id AS 'answer_id',
			ta.is_answer_true ,
			ta.answer_content,
			td2.label as 'answer_select' 
		FROM
			( SELECT * FROM t_exam_publish WHERE `status` = 1 ) tep
			LEFT JOIN ( SELECT * FROM t_exam_paper WHERE `status` = 1 ) tepa ON tepa.id = tep.exam_id
			LEFT JOIN t_exam_paper_question txpq ON tepa.id = txpq.exam_id
			LEFT JOIN ( SELECT * FROM t_question WHERE `status` = 1 ) tq ON txpq.question_id = tq.id
			LEFT JOIN ( SELECT * FROM t_dict WHERE `status` = 1 AND type = 1 ) td1 ON tq.question_type = td1.`value`
			LEFT JOIN t_answer ta ON tq.id = ta.question_id
			LEFT JOIN (select * from t_dict  where `status` = 1 )td2  on  td2.id = ta.answer_select 
		WHERE
			tep.id = #{0}
			and ta.is_answer_true= 1
	</select>
	
	
	<!-- 学生考试答案记录 -->
	<insert id="insertStudentExamAnswer" >
		insert into t_student_exam_answer (exam_pulish_id,student_id,question_id,my_answer)
		values  
		<foreach collection="qaList" separator="," item="valas" >
			(#{taskId},#{studentId},#{valas.questionId},#{valas.answerId})
		</foreach>
	</insert>
	
	<!-- 当前问题的正确答案 ,入参的是一个答案id  -->
	<select id="selectStudentExamAnswer" resultType="com.ssm.vo.YExamQuestionTrueSelectVO">
		select question_id,(select label from t_dict  td where td.`status` = 1 and  td.id = ta.answer_select) answer_select from t_answer ta  where ta.id in 
		<foreach collection="array" item="arr" open="(" close=")" separator=",">
			#{arr}
		</foreach>
	</select>
	
	<!-- 查询该学生下的所有任务 -->
	<select id="selectStudentTask" resultType="com.ssm.vo.YUserTaskVO" >
		SELECT
			txr.exam_pulish_id,txr.score,txr.create_time,td1.label,txpt.exam_paper_title 
		FROM
			( SELECT * FROM t_exam_record WHERE `status` = 1 ) txr 
			left join (select * from t_exam_publish where `status` = 1  ) tep  on tep.id = txr.exam_pulish_id
			left join (select * from t_exam_paper where `status` = 1 ) txpt on txpt.id = tep.exam_id
			left join (select * from t_dict where `status` = 1 and type='examType' ) td1  on td1.`value` = txpt.exam_paper_type
		where txr.student_id = #{0}
		order by txr.create_time desc
	</select>
	
	<resultMap type="com.ssm.pojo.TTestRecord" id="testRecordTemp">
		<id property="id" column="id" />
		<result property="testName" column="test_name" />
		<result property="studentId" column="student_id" />
		<result property="totalTime" column="total_time" />
		<result property="accuracy" column="accuracy" />
		<result property="createTime" column="create_time" />

	</resultMap>
	<!-- 查询该学生下的所有练习记录。 -->
	<select id="selectStudentExerciseTask"  resultMap="testRecordTemp">
		select * from t_test_record where student_id = #{0}
	</select>
	
</mapper>